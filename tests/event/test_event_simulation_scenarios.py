#  Copyright 2023 Hathor Labs
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

from hathor.event.model.base_event import BaseEvent
from hathor.event.model.event_data import EmptyData, ReorgData, SpentOutput, TxData, TxInput, TxMetadata, TxOutput
from hathor.event.model.event_type import EventType
from hathor.event.websocket.request import StartStreamRequest
from hathor.event.websocket.response import EventResponse
from hathor.p2p.peer_id import PeerId
from hathor.simulator import FakeConnection
from hathor.simulator.trigger import StopAfterNMinedBlocks, StopAfterNTransactions
from tests.event.event_simulation_tester import (
    BaseEventSimulationTester,
    MemoryEventSimulationTester,
    RocksDBEventSimulationTester,
)
from tests.utils import zip_chunkify


class BaseEventSimulationScenariosTest(BaseEventSimulationTester):
    """
    NOTE: The lists of expected events used in tests below were generated by printing the event responses list to the
    console and then copying the output and manipulating it to create instances.
    """

    seed_config = 6946502462188444706

    def test_only_load(self) -> None:
        start_stream = StartStreamRequest(type='START_STREAM', window_size=1_000_000, last_ack_event_id=None)
        self._send_request(start_stream)
        self.simulator.run(3600)

        responses = self._get_success_responses()

        expected = [
            # LOAD_STATED
            EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=0, timestamp=1578878880.0, type=EventType.LOAD_STARTED, data=EmptyData(), group_id=None), latest_event_id=4),  # noqa: E501
            # One NEW_VERTEX_ACCEPTED for each genesis (1 block and 2 txs)
            EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=1, timestamp=1578878880.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', nonce=0, timestamp=1572636343, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=100000000000, script='dqkU/QUFm2AGJJVDuC82h2oXxz/SJnuIrA==', token_data=0)], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=2.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=4),   # noqa: E501
            EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=2, timestamp=1578878880.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', nonce=6, timestamp=1572636344, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=2.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=4),  # noqa: E501
            EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=3, timestamp=1578878880.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', nonce=2, timestamp=1572636345, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=2.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=4),  # noqa: E501
            # LOAD_FINISHED
            EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=4, timestamp=1578878880.0, type=EventType.LOAD_FINISHED, data=EmptyData(), group_id=None), latest_event_id=4)  # noqa: E501
        ]

        assert responses == expected

    def test_single_chain_one_block(self):
        miner = self.simulator.create_miner(self.manager, hashpower=1e6)
        miner.start()

        trigger = StopAfterNMinedBlocks(miner, quantity=1)
        self.simulator.run(3600, trigger=trigger)
        miner.stop()

        start_stream = StartStreamRequest(type='START_STREAM', window_size=1_000_000, last_ack_event_id=None)
        self._send_request(start_stream)
        self.simulator.run(3600)

        responses = self._get_success_responses()

        expected = [
            [
                # LOAD_STATED
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=0, timestamp=1578878880.0, type=EventType.LOAD_STARTED, data=EmptyData(), group_id=None), latest_event_id=8),  # noqa E501
                # One NEW_VERTEX_ACCEPTED for each genesis (1 block and 2 txs)
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=1, timestamp=1578878880.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', nonce=0, timestamp=1572636343, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=100000000000, script='dqkU/QUFm2AGJJVDuC82h2oXxz/SJnuIrA==', token_data=0)], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=2.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=8),   # noqa: E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=2, timestamp=1578878880.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', nonce=6, timestamp=1572636344, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=2.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=8),  # noqa: E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=3, timestamp=1578878880.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', nonce=2, timestamp=1572636345, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=2.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=8),  # noqa: E501
                # LOAD_FINISHED
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=4, timestamp=1578878880.0, type=EventType.LOAD_FINISHED, data=EmptyData(), group_id=None), latest_event_id=8),  # noqa E501
            ],
            UnorderedList([
                # One VERTEX_METADATA_CHANGED for a new block (below), and one VERTEX_METADATA_CHANGED for each genesis tx (2), adding the new block as their child  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=7, timestamp=1578878910.25, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', nonce=2, timestamp=1572636345, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=['53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360'], twins=[], accumulated_weight=2.0, score=2.0, first_block='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=8),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=5, timestamp=1578878910.25, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', nonce=6, timestamp=1572636344, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=['53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360'], twins=[], accumulated_weight=2.0, score=2.0, first_block='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=8),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=6, timestamp=1578878910.25, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', nonce=105631935, timestamp=1578878910, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUPXOcGnrN0ZB2WrnPVcjdCCcacL+IrA==', token_data=0)], parents=['339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.0, first_block=None, height=1, validation='full'), aux_pow=None), group_id=None), latest_event_id=8),  # noqa E501
            ]),
            [
                # One NEW_VERTEX_ACCEPTED for a new block
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=8, timestamp=1578878910.25, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', nonce=105631935, timestamp=1578878910, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUPXOcGnrN0ZB2WrnPVcjdCCcacL+IrA==', token_data=0)], parents=['339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.0, first_block=None, height=1, validation='full'), aux_pow=None), group_id=None), latest_event_id=8)  # noqa E501
            ]
        ]

        _assert_equal_events(responses, expected)

    def test_single_chain_blocks_and_transactions(self):
        miner = self.simulator.create_miner(self.manager, hashpower=1e6)
        tx_gen = self.simulator.create_tx_generator(self.manager, rate=3 / 60, hashpower=1e6, ignore_no_funds=True)

        miner_trigger = StopAfterNMinedBlocks(miner, quantity=11)
        miner.start()
        self.simulator.run(3600, trigger=miner_trigger)
        miner.stop()

        tx_trigger = StopAfterNTransactions(tx_gen, quantity=2)
        tx_gen.start()
        self.simulator.run(3600, trigger=tx_trigger)
        tx_gen.stop()

        miner_trigger = StopAfterNMinedBlocks(miner, quantity=1)
        miner.start()
        self.simulator.run(3600, trigger=miner_trigger)
        miner.stop()

        self.simulator.run(3600)
        start_stream = StartStreamRequest(type='START_STREAM', window_size=1_000_000, last_ack_event_id=None)
        self._send_request(start_stream)
        self.simulator.run(3600)

        responses = self._get_success_responses()

        expected = [
            [
                # LOAD_STATED
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=0, timestamp=1578878880.0, type=EventType.LOAD_STARTED, data=EmptyData(), group_id=None), latest_event_id=36),  # noqa E501
                # One NEW_VERTEX_ACCEPTED for each genesis (1 block and 2 txs)
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=1, timestamp=1578878880.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', nonce=0, timestamp=1572636343, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=100000000000, script='dqkU/QUFm2AGJJVDuC82h2oXxz/SJnuIrA==', token_data=0)], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=2.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),   # noqa: E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=2, timestamp=1578878880.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', nonce=6, timestamp=1572636344, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=2.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa: E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=3, timestamp=1578878880.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', nonce=2, timestamp=1572636345, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=2.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa: E501
                # LOAD_FINISHED
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=4, timestamp=1578878880.0, type=EventType.LOAD_FINISHED, data=EmptyData(), group_id=None), latest_event_id=36),  # noqa E501
            ],
            UnorderedList([
                # One VERTEX_METADATA_CHANGED for a new block (below), and one VERTEX_METADATA_CHANGED for each genesis tx (2), adding the new block as their child  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=5, timestamp=1578878910.25, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', nonce=6, timestamp=1572636344, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=['53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360'], twins=[], accumulated_weight=2.0, score=2.0, first_block='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=6, timestamp=1578878910.25, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', nonce=2, timestamp=1572636345, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=['53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360'], twins=[], accumulated_weight=2.0, score=2.0, first_block='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=7, timestamp=1578878910.25, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', nonce=105631935, timestamp=1578878910, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUPXOcGnrN0ZB2WrnPVcjdCCcacL+IrA==', token_data=0)], parents=['339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.0, first_block=None, height=1, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
            ]),
            [
                # One NEW_VERTEX_ACCEPTED for a new block
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=8, timestamp=1578878910.25, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', nonce=105631935, timestamp=1578878910, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUPXOcGnrN0ZB2WrnPVcjdCCcacL+IrA==', token_data=0)], parents=['339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.0, first_block=None, height=1, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                # One VERTEX_METADATA_CHANGED and one NEW_VERTEX_ACCEPTED for 10 new blocks
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=9, timestamp=1578878910.5, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='967f7d6577e5b301d7facaf7fecd87f18586acfd24fc52e49251c9c4195b49f6', nonce=1279407725, timestamp=1578878911, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUXRFxfhIYOXURHjiAlx9XPuMh7E2IrA==', token_data=0)], parents=['53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='967f7d6577e5b301d7facaf7fecd87f18586acfd24fc52e49251c9c4195b49f6', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.321928094887363, first_block=None, height=2, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=10, timestamp=1578878910.5, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='967f7d6577e5b301d7facaf7fecd87f18586acfd24fc52e49251c9c4195b49f6', nonce=1279407725, timestamp=1578878911, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUXRFxfhIYOXURHjiAlx9XPuMh7E2IrA==', token_data=0)], parents=['53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='967f7d6577e5b301d7facaf7fecd87f18586acfd24fc52e49251c9c4195b49f6', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.321928094887363, first_block=None, height=2, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=11, timestamp=1578878910.75, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='68585cc41a0cc261e97e5cf9d035e4950a9897b9fba18cbec194824522c03c7b', nonce=1529920189, timestamp=1578878912, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUu9S/kjy3HbglEu3bA4JargdORiiIrA==', token_data=0)], parents=['967f7d6577e5b301d7facaf7fecd87f18586acfd24fc52e49251c9c4195b49f6', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='68585cc41a0cc261e97e5cf9d035e4950a9897b9fba18cbec194824522c03c7b', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.584962500721156, first_block=None, height=3, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=12, timestamp=1578878910.75, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='68585cc41a0cc261e97e5cf9d035e4950a9897b9fba18cbec194824522c03c7b', nonce=1529920189, timestamp=1578878912, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUu9S/kjy3HbglEu3bA4JargdORiiIrA==', token_data=0)], parents=['967f7d6577e5b301d7facaf7fecd87f18586acfd24fc52e49251c9c4195b49f6', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='68585cc41a0cc261e97e5cf9d035e4950a9897b9fba18cbec194824522c03c7b', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.584962500721156, first_block=None, height=3, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=13, timestamp=1578878911.0, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='0ed0c5540b258485199d1938646bcf10fc3b086da1110af41806c6d0792f413e', nonce=1828786391, timestamp=1578878913, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUzskI6jayLvTobJDhpVZiuMu7zt+IrA==', token_data=0)], parents=['68585cc41a0cc261e97e5cf9d035e4950a9897b9fba18cbec194824522c03c7b', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='0ed0c5540b258485199d1938646bcf10fc3b086da1110af41806c6d0792f413e', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.807354922057604, first_block=None, height=4, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=14, timestamp=1578878911.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='0ed0c5540b258485199d1938646bcf10fc3b086da1110af41806c6d0792f413e', nonce=1828786391, timestamp=1578878913, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUzskI6jayLvTobJDhpVZiuMu7zt+IrA==', token_data=0)], parents=['68585cc41a0cc261e97e5cf9d035e4950a9897b9fba18cbec194824522c03c7b', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='0ed0c5540b258485199d1938646bcf10fc3b086da1110af41806c6d0792f413e', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.807354922057604, first_block=None, height=4, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=15, timestamp=1578878911.25, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='79c4da1aa12adbb3e384f3e631cf0f8898922db6a7a157c878d6dd5d27b62e77', nonce=1915673046, timestamp=1578878914, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkU7B7Cf/pnj2DglfhnqyiRzxNg+K2IrA==', token_data=0)], parents=['0ed0c5540b258485199d1938646bcf10fc3b086da1110af41806c6d0792f413e', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='79c4da1aa12adbb3e384f3e631cf0f8898922db6a7a157c878d6dd5d27b62e77', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=5.0, first_block=None, height=5, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=16, timestamp=1578878911.25, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='79c4da1aa12adbb3e384f3e631cf0f8898922db6a7a157c878d6dd5d27b62e77', nonce=1915673046, timestamp=1578878914, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkU7B7Cf/pnj2DglfhnqyiRzxNg+K2IrA==', token_data=0)], parents=['0ed0c5540b258485199d1938646bcf10fc3b086da1110af41806c6d0792f413e', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='79c4da1aa12adbb3e384f3e631cf0f8898922db6a7a157c878d6dd5d27b62e77', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=5.0, first_block=None, height=5, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=17, timestamp=1578878911.5, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='0c88949d8b9eef81bf0896aabe875c4bd1172bc834b7bc4cc1c756a3d243ec52', nonce=1279525218, timestamp=1578878915, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUZmTJ0of2Ce9iuycIVpFCVU08WmKIrA==', token_data=0)], parents=['79c4da1aa12adbb3e384f3e631cf0f8898922db6a7a157c878d6dd5d27b62e77', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='0c88949d8b9eef81bf0896aabe875c4bd1172bc834b7bc4cc1c756a3d243ec52', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=5.169925001442312, first_block=None, height=6, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=18, timestamp=1578878911.5, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='0c88949d8b9eef81bf0896aabe875c4bd1172bc834b7bc4cc1c756a3d243ec52', nonce=1279525218, timestamp=1578878915, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUZmTJ0of2Ce9iuycIVpFCVU08WmKIrA==', token_data=0)], parents=['79c4da1aa12adbb3e384f3e631cf0f8898922db6a7a157c878d6dd5d27b62e77', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='0c88949d8b9eef81bf0896aabe875c4bd1172bc834b7bc4cc1c756a3d243ec52', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=5.169925001442312, first_block=None, height=6, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=19, timestamp=1578878911.75, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='3624a05261b604d4ff46b0157892b2ff48a7fb1e31fe65e58fbbfe88cadcbdd4', nonce=4136633663, timestamp=1578878916, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUPNN8M/qangqd2wYSzu0u+3OmwDmIrA==', token_data=0)], parents=['0c88949d8b9eef81bf0896aabe875c4bd1172bc834b7bc4cc1c756a3d243ec52', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='3624a05261b604d4ff46b0157892b2ff48a7fb1e31fe65e58fbbfe88cadcbdd4', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=5.321928094887363, first_block=None, height=7, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=20, timestamp=1578878911.75, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='3624a05261b604d4ff46b0157892b2ff48a7fb1e31fe65e58fbbfe88cadcbdd4', nonce=4136633663, timestamp=1578878916, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUPNN8M/qangqd2wYSzu0u+3OmwDmIrA==', token_data=0)], parents=['0c88949d8b9eef81bf0896aabe875c4bd1172bc834b7bc4cc1c756a3d243ec52', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='3624a05261b604d4ff46b0157892b2ff48a7fb1e31fe65e58fbbfe88cadcbdd4', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=5.321928094887363, first_block=None, height=7, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=21, timestamp=1578878912.0, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='282d65827ecc485b1c8b916f71605da0f15f353325feb9a1a87fe320c1ebc915', nonce=945260546, timestamp=1578878917, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUxbNqvpWbgNtk9km/VuYhzHHMp76IrA==', token_data=0)], parents=['3624a05261b604d4ff46b0157892b2ff48a7fb1e31fe65e58fbbfe88cadcbdd4', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='282d65827ecc485b1c8b916f71605da0f15f353325feb9a1a87fe320c1ebc915', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=5.459431618637297, first_block=None, height=8, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=22, timestamp=1578878912.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='282d65827ecc485b1c8b916f71605da0f15f353325feb9a1a87fe320c1ebc915', nonce=945260546, timestamp=1578878917, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUxbNqvpWbgNtk9km/VuYhzHHMp76IrA==', token_data=0)], parents=['3624a05261b604d4ff46b0157892b2ff48a7fb1e31fe65e58fbbfe88cadcbdd4', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='282d65827ecc485b1c8b916f71605da0f15f353325feb9a1a87fe320c1ebc915', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=5.459431618637297, first_block=None, height=8, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=23, timestamp=1578878912.25, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='4978ebbeb98dccae64f3d32269e1a1030892c82b023448cafd649cad73e9127a', nonce=2222918728, timestamp=1578878918, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkU48C0XcFpiaWq2gwTICyEVdvJXcCIrA==', token_data=0)], parents=['282d65827ecc485b1c8b916f71605da0f15f353325feb9a1a87fe320c1ebc915', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='4978ebbeb98dccae64f3d32269e1a1030892c82b023448cafd649cad73e9127a', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=5.584962500721156, first_block=None, height=9, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=24, timestamp=1578878912.25, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='4978ebbeb98dccae64f3d32269e1a1030892c82b023448cafd649cad73e9127a', nonce=2222918728, timestamp=1578878918, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkU48C0XcFpiaWq2gwTICyEVdvJXcCIrA==', token_data=0)], parents=['282d65827ecc485b1c8b916f71605da0f15f353325feb9a1a87fe320c1ebc915', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='4978ebbeb98dccae64f3d32269e1a1030892c82b023448cafd649cad73e9127a', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=5.584962500721156, first_block=None, height=9, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=25, timestamp=1578878912.5, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='47ced60615a9d5d4fc1ca26d9dbc71ca89b8b35541b31d8e75a65d4badfa99c7', nonce=3090209358, timestamp=1578878919, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUmQRjqRyxq26raJZnhnpRJsrS9n2IrA==', token_data=0)], parents=['4978ebbeb98dccae64f3d32269e1a1030892c82b023448cafd649cad73e9127a', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='47ced60615a9d5d4fc1ca26d9dbc71ca89b8b35541b31d8e75a65d4badfa99c7', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=5.700439718141092, first_block=None, height=10, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=26, timestamp=1578878912.5, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='47ced60615a9d5d4fc1ca26d9dbc71ca89b8b35541b31d8e75a65d4badfa99c7', nonce=3090209358, timestamp=1578878919, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUmQRjqRyxq26raJZnhnpRJsrS9n2IrA==', token_data=0)], parents=['4978ebbeb98dccae64f3d32269e1a1030892c82b023448cafd649cad73e9127a', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='47ced60615a9d5d4fc1ca26d9dbc71ca89b8b35541b31d8e75a65d4badfa99c7', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=5.700439718141092, first_block=None, height=10, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=27, timestamp=1578878912.75, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='15599c25cb30892add963558e06c97c2a838a8a5c047aee416dc9a3617d59baa', nonce=3024981275, timestamp=1578878920, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUYFHjcujZZHs0JWZkriEbn5jTv/aIrA==', token_data=0)], parents=['47ced60615a9d5d4fc1ca26d9dbc71ca89b8b35541b31d8e75a65d4badfa99c7', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='15599c25cb30892add963558e06c97c2a838a8a5c047aee416dc9a3617d59baa', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=5.807354922057604, first_block=None, height=11, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=28, timestamp=1578878912.75, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='15599c25cb30892add963558e06c97c2a838a8a5c047aee416dc9a3617d59baa', nonce=3024981275, timestamp=1578878920, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUYFHjcujZZHs0JWZkriEbn5jTv/aIrA==', token_data=0)], parents=['47ced60615a9d5d4fc1ca26d9dbc71ca89b8b35541b31d8e75a65d4badfa99c7', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='15599c25cb30892add963558e06c97c2a838a8a5c047aee416dc9a3617d59baa', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=5.807354922057604, first_block=None, height=11, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
            ],
            UnorderedList([
                # One VERTEX_METADATA_CHANGED for a new tx (below), and one VERTEX_METADATA_CHANGED for a block, adding the new tx as spending their output  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=30, timestamp=1578879395.5, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', nonce=105631935, timestamp=1578878910, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUPXOcGnrN0ZB2WrnPVcjdCCcacL+IrA==', token_data=0)], parents=['339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', spent_outputs=[SpentOutput(index=0, tx_ids=['bd1c5ae097470eecfe10b3f25e02c0f8358b95706484b2174c6ea0ff930cc25c'])], conflict_with=[], voided_by=[], received_by=[], children=['967f7d6577e5b301d7facaf7fecd87f18586acfd24fc52e49251c9c4195b49f6'], twins=[], accumulated_weight=2.0, score=4.0, first_block=None, height=1, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=29, timestamp=1578879395.5, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='bd1c5ae097470eecfe10b3f25e02c0f8358b95706484b2174c6ea0ff930cc25c', nonce=0, timestamp=1578879395, version=1, weight=18.648830153779993, inputs=[TxInput(tx_id='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', index=0, data='RjBEAiBQAVgs/jYpndowN3/JMI07fM886ergyyGA2xXaHCu5BQIgf58pdc8S9ABgzkUx8qDQUtV3FcYCMMzHs90q36L0J+whA0zN7LEgxcswPkHbbW7mdnkS5yviaZFgjID1mhpSZSQf')], outputs=[TxOutput(value=2132, script='dqkUutgaVG8W5OnzgAEVUqB4XgmDgm2IrA==', token_data=0), TxOutput(value=4268, script='dqkUBvl1aaAtzoh8a9vaZoqXA6JxK4OIrA==', token_data=0)], parents=['16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='bd1c5ae097470eecfe10b3f25e02c0f8358b95706484b2174c6ea0ff930cc25c', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=18.648830153779993, score=0.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
            ]),
            [
                # One NEW_VERTEX_ACCEPTED for a new tx
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=31, timestamp=1578879395.5, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='bd1c5ae097470eecfe10b3f25e02c0f8358b95706484b2174c6ea0ff930cc25c', nonce=0, timestamp=1578879395, version=1, weight=18.648830153779993, inputs=[TxInput(tx_id='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', index=0, data='RjBEAiBQAVgs/jYpndowN3/JMI07fM886ergyyGA2xXaHCu5BQIgf58pdc8S9ABgzkUx8qDQUtV3FcYCMMzHs90q36L0J+whA0zN7LEgxcswPkHbbW7mdnkS5yviaZFgjID1mhpSZSQf')], outputs=[TxOutput(value=2132, script='dqkUutgaVG8W5OnzgAEVUqB4XgmDgm2IrA==', token_data=0), TxOutput(value=4268, script='dqkUBvl1aaAtzoh8a9vaZoqXA6JxK4OIrA==', token_data=0)], parents=['16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='bd1c5ae097470eecfe10b3f25e02c0f8358b95706484b2174c6ea0ff930cc25c', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=18.648830153779993, score=0.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
            ],
            UnorderedList([
                # One VERTEX_METADATA_CHANGED for a new tx (below), and one VERTEX_METADATA_CHANGED for a block, adding the new tx as spending their output  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=32, timestamp=1578879429.0, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='bd1c5ae097470eecfe10b3f25e02c0f8358b95706484b2174c6ea0ff930cc25c', nonce=0, timestamp=1578879395, version=1, weight=18.648830153779993, inputs=[TxInput(tx_id='53c5fe57a6d79ab4a8eca660bd0a9935fe9f82d2506d80e0c48339c42c234360', index=0, data='RjBEAiBQAVgs/jYpndowN3/JMI07fM886ergyyGA2xXaHCu5BQIgf58pdc8S9ABgzkUx8qDQUtV3FcYCMMzHs90q36L0J+whA0zN7LEgxcswPkHbbW7mdnkS5yviaZFgjID1mhpSZSQf')], outputs=[TxOutput(value=2132, script='dqkUutgaVG8W5OnzgAEVUqB4XgmDgm2IrA==', token_data=0), TxOutput(value=4268, script='dqkUBvl1aaAtzoh8a9vaZoqXA6JxK4OIrA==', token_data=0)], parents=['16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='bd1c5ae097470eecfe10b3f25e02c0f8358b95706484b2174c6ea0ff930cc25c', spent_outputs=[SpentOutput(index=0, tx_ids=['47b26240891fb57320d72cbd708f5287ca056e73f4b19bb295e6b19d984c07ea']), SpentOutput(index=1, tx_ids=['47b26240891fb57320d72cbd708f5287ca056e73f4b19bb295e6b19d984c07ea'])], conflict_with=[], voided_by=[], received_by=[], children=['47b26240891fb57320d72cbd708f5287ca056e73f4b19bb295e6b19d984c07ea'], twins=[], accumulated_weight=18.648830153779993, score=0.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=33, timestamp=1578879429.0, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='47b26240891fb57320d72cbd708f5287ca056e73f4b19bb295e6b19d984c07ea', nonce=0, timestamp=1578879423, version=1, weight=19.563446104298656, inputs=[TxInput(tx_id='bd1c5ae097470eecfe10b3f25e02c0f8358b95706484b2174c6ea0ff930cc25c', index=0, data='RzBFAiANP0tUHsWIPFnkwG0Io7W53viGaXgWfyniIsyJHIva7AIhAIij02z4JPki4RT5b/UkJoKVgazA7QWIq1Zwvik2xhXZIQOnBXShvpioJZgNxYy4lgCg4o84Uw9ncOQuv9mxPWEqeg=='), TxInput(tx_id='bd1c5ae097470eecfe10b3f25e02c0f8358b95706484b2174c6ea0ff930cc25c', index=1, data='RjBEAiAj6I8PifTvE1J7eAqxHLu2YqFThzc4C4YzIzq+aX1fBQIgdH+xu08lWjdGiRjuaYgf/S9EZYw8U1HJQ2//WtERx9chA9euCC5MDnVV3I2e5yKj1Q65BsqgN2+IwojZqatIF3T8')], outputs=[TxOutput(value=2764, script='dqkUmkey79Rbhjq4BtHYCm2mT8hDprWIrA==', token_data=0), TxOutput(value=3636, script='dqkUFgE9a6rVMusN303z18sYfjdpYGqIrA==', token_data=0)], parents=['bd1c5ae097470eecfe10b3f25e02c0f8358b95706484b2174c6ea0ff930cc25c', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='47b26240891fb57320d72cbd708f5287ca056e73f4b19bb295e6b19d984c07ea', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=19.563446104298656, score=0.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
            ]),
            [
                # One NEW_VERTEX_ACCEPTED for a new tx
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=34, timestamp=1578879429.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='47b26240891fb57320d72cbd708f5287ca056e73f4b19bb295e6b19d984c07ea', nonce=0, timestamp=1578879423, version=1, weight=19.563446104298656, inputs=[TxInput(tx_id='bd1c5ae097470eecfe10b3f25e02c0f8358b95706484b2174c6ea0ff930cc25c', index=0, data='RzBFAiANP0tUHsWIPFnkwG0Io7W53viGaXgWfyniIsyJHIva7AIhAIij02z4JPki4RT5b/UkJoKVgazA7QWIq1Zwvik2xhXZIQOnBXShvpioJZgNxYy4lgCg4o84Uw9ncOQuv9mxPWEqeg=='), TxInput(tx_id='bd1c5ae097470eecfe10b3f25e02c0f8358b95706484b2174c6ea0ff930cc25c', index=1, data='RjBEAiAj6I8PifTvE1J7eAqxHLu2YqFThzc4C4YzIzq+aX1fBQIgdH+xu08lWjdGiRjuaYgf/S9EZYw8U1HJQ2//WtERx9chA9euCC5MDnVV3I2e5yKj1Q65BsqgN2+IwojZqatIF3T8')], outputs=[TxOutput(value=2764, script='dqkUmkey79Rbhjq4BtHYCm2mT8hDprWIrA==', token_data=0), TxOutput(value=3636, script='dqkUFgE9a6rVMusN303z18sYfjdpYGqIrA==', token_data=0)], parents=['bd1c5ae097470eecfe10b3f25e02c0f8358b95706484b2174c6ea0ff930cc25c', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='47b26240891fb57320d72cbd708f5287ca056e73f4b19bb295e6b19d984c07ea', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=19.563446104298656, score=0.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
            ],
            [
                # One VERTEX_METADATA_CHANGED and one NEW_VERTEX_ACCEPTED for a new block
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=35, timestamp=1578879429.25, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='f2d1327e556ac534e0d934c4e884af3ffe5ecdfd7c5045e30a123a8171500990', nonce=2907562093, timestamp=1578878921, version=0, weight=8.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUBvl1aaAtzoh8a9vaZoqXA6JxK4OIrA==', token_data=0)], parents=['15599c25cb30892add963558e06c97c2a838a8a5c047aee416dc9a3617d59baa', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='f2d1327e556ac534e0d934c4e884af3ffe5ecdfd7c5045e30a123a8171500990', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=8.0, score=8.285402218862249, first_block=None, height=12, validation='full'), aux_pow=None), group_id=None), latest_event_id=36),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=36, timestamp=1578879429.25, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='f2d1327e556ac534e0d934c4e884af3ffe5ecdfd7c5045e30a123a8171500990', nonce=2907562093, timestamp=1578878921, version=0, weight=8.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUBvl1aaAtzoh8a9vaZoqXA6JxK4OIrA==', token_data=0)], parents=['15599c25cb30892add963558e06c97c2a838a8a5c047aee416dc9a3617d59baa', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='f2d1327e556ac534e0d934c4e884af3ffe5ecdfd7c5045e30a123a8171500990', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=8.0, score=8.285402218862249, first_block=None, height=12, validation='full'), aux_pow=None), group_id=None), latest_event_id=36)  # noqa E501
            ]
        ]

        _assert_equal_events(responses, expected)

    def test_reorg(self):
        miner1 = self.simulator.create_miner(self.manager, hashpower=1e6)

        builder = self.simulator.get_default_builder().set_peer_id(PeerId())
        manager2 = self.simulator.create_peer(builder)
        manager2.allow_mining_without_peers()

        miner2 = self.simulator.create_miner(manager2, hashpower=1e6)

        connection = FakeConnection(self.manager, manager2, latency=1)
        self.simulator.add_connection(connection)

        trigger1 = StopAfterNMinedBlocks(miner1, quantity=1)
        miner1.start()
        self.simulator.run(3600, trigger=trigger1)
        miner1.stop()

        trigger2 = StopAfterNMinedBlocks(miner2, quantity=2)
        miner2.start()
        self.simulator.run(3600, trigger=trigger2)
        miner2.stop()

        self.simulator.run(3600)
        start_stream = StartStreamRequest(type='START_STREAM', window_size=1_000_000, last_ack_event_id=None)
        self._send_request(start_stream)
        self.simulator.run(3600)

        responses = self._get_success_responses()

        expected = [
            [
                # LOAD_STATED
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=0, timestamp=1578878880.0, type=EventType.LOAD_STARTED, data=EmptyData(), group_id=None), latest_event_id=20),  # noqa E501
                # One NEW_VERTEX_ACCEPTED for each genesis (1 block and 2 txs)
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=1, timestamp=1578878880.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', nonce=0, timestamp=1572636343, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=100000000000, script='dqkU/QUFm2AGJJVDuC82h2oXxz/SJnuIrA==', token_data=0)], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=2.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=20),   # noqa: E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=2, timestamp=1578878880.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', nonce=6, timestamp=1572636344, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=2.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=20),  # noqa: E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=3, timestamp=1578878880.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', nonce=2, timestamp=1572636345, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=2.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=20),  # noqa: E501
                # LOAD_FINISHED
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=4, timestamp=1578878880.0, type=EventType.LOAD_FINISHED, data=EmptyData(), group_id=None), latest_event_id=20),  # noqa E501
            ],
            UnorderedList([
                # One VERTEX_METADATA_CHANGED for a new block (below), and one VERTEX_METADATA_CHANGED for each genesis tx (2), adding the new block as their child  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=5, timestamp=1578878940.25, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', nonce=2, timestamp=1572636345, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=['3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3'], twins=[], accumulated_weight=2.0, score=2.0, first_block='3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3', height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=20),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=7, timestamp=1578878940.25, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', nonce=6, timestamp=1572636344, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=['3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3'], twins=[], accumulated_weight=2.0, score=2.0, first_block='3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3', height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=20),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=6, timestamp=1578878940.25, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3', nonce=2246536493, timestamp=1578878940, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUPXOcGnrN0ZB2WrnPVcjdCCcacL+IrA==', token_data=0)], parents=['339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.0, first_block=None, height=1, validation='full'), aux_pow=None), group_id=None), latest_event_id=20),  # noqa E501
            ]),
            [
                # One NEW_VERTEX_ACCEPTED for a new block from manager1
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=8, timestamp=1578878940.25, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3', nonce=2246536493, timestamp=1578878940, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUPXOcGnrN0ZB2WrnPVcjdCCcacL+IrA==', token_data=0)], parents=['339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.0, first_block=None, height=1, validation='full'), aux_pow=None), group_id=None), latest_event_id=20),  # noqa E501
            ],
            UnorderedList([
                # One VERTEX_METADATA_CHANGED for a new block (below), and one VERTEX_METADATA_CHANGED for each genesis tx (2), adding the new block as their child  # noqa E501
                # Also one VERTEX_METADATA_CHANGED for the previous block, voiding it
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=9, timestamp=1578878955.75, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', nonce=2, timestamp=1572636345, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=['3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3', '4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7'], twins=[], accumulated_weight=2.0, score=2.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=20),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=12, timestamp=1578878955.75, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', nonce=6, timestamp=1572636344, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=['3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3', '4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7'], twins=[], accumulated_weight=2.0, score=2.0, first_block=None, height=0, validation='full'), aux_pow=None), group_id=None), latest_event_id=20),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=11, timestamp=1578878955.75, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3', nonce=2246536493, timestamp=1578878940, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUPXOcGnrN0ZB2WrnPVcjdCCcacL+IrA==', token_data=0)], parents=['339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3', spent_outputs=[], conflict_with=[], voided_by=['3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3'], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.0, first_block=None, height=1, validation='full'), aux_pow=None), group_id=None), latest_event_id=20),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=10, timestamp=1578878955.75, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7', nonce=1279525218, timestamp=1578878940, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUfBo1MGBHkHtXDktO+BxtBdh5T5GIrA==', token_data=0)], parents=['339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7', spent_outputs=[], conflict_with=[], voided_by=['4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7'], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.0, first_block=None, height=1, validation='full'), aux_pow=None), group_id=None), latest_event_id=20),  # noqa E501
            ]),
            [
                # One NEW_VERTEX_ACCEPTED for a new block from manager2
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=13, timestamp=1578878955.75, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7', nonce=1279525218, timestamp=1578878940, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUfBo1MGBHkHtXDktO+BxtBdh5T5GIrA==', token_data=0)], parents=['339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7', spent_outputs=[], conflict_with=[], voided_by=['4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7'], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.0, first_block=None, height=1, validation='full'), aux_pow=None), group_id=None), latest_event_id=20),  # noqa E501
                # REORG_STARTED caused by a new block from manager2 (below)
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=14, timestamp=1578878956.0, type=EventType.REORG_STARTED, data=ReorgData(reorg_size=1, previous_best_block='3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3', new_best_block='a729a7abb4248dffa492dd2c2634aa6d92b3e1e05bfa6614118b6ba97bfba5c4', common_block='339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792'), group_id=0), latest_event_id=20),  # noqa E501
            ],
            UnorderedList([
                # One VERTEX_METADATA_CHANGED for a new block (below), and one VERTEX_METADATA_CHANGED for each genesis tx (2), adding the new block as their child  # noqa E501
                # Also one VERTEX_METADATA_CHANGED for the previous block, un-voiding it as it's now part of the best blockchain  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=15, timestamp=1578878956.0, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', nonce=2, timestamp=1572636345, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=['3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3', '4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7', 'a729a7abb4248dffa492dd2c2634aa6d92b3e1e05bfa6614118b6ba97bfba5c4'], twins=[], accumulated_weight=2.0, score=2.0, first_block='4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7', height=0, validation='full'), aux_pow=None), group_id=0), latest_event_id=20),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=18, timestamp=1578878956.0, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', nonce=6, timestamp=1572636344, version=1, weight=2.0, inputs=[], outputs=[], parents=[], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=['3cfde60f140d2838581d885e656af1049fa8eab964defc5bca3d883b83c9afc3', '4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7', 'a729a7abb4248dffa492dd2c2634aa6d92b3e1e05bfa6614118b6ba97bfba5c4'], twins=[], accumulated_weight=2.0, score=2.0, first_block='4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7', height=0, validation='full'), aux_pow=None), group_id=0), latest_event_id=20),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=17, timestamp=1578878956.0, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7', nonce=1279525218, timestamp=1578878940, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUfBo1MGBHkHtXDktO+BxtBdh5T5GIrA==', token_data=0)], parents=['339f47da87435842b0b1b528ecd9eac2495ce983b3e9c923a37e1befbe12c792', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=['a729a7abb4248dffa492dd2c2634aa6d92b3e1e05bfa6614118b6ba97bfba5c4'], twins=[], accumulated_weight=2.0, score=4.0, first_block=None, height=1, validation='full'), aux_pow=None), group_id=0), latest_event_id=20),  # noqa E501
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=16, timestamp=1578878956.0, type=EventType.VERTEX_METADATA_CHANGED, data=TxData(hash='a729a7abb4248dffa492dd2c2634aa6d92b3e1e05bfa6614118b6ba97bfba5c4', nonce=4136633663, timestamp=1578878941, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUgQrqLefPfPVpkXlfvvAp943epyOIrA==', token_data=0)], parents=['4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='a729a7abb4248dffa492dd2c2634aa6d92b3e1e05bfa6614118b6ba97bfba5c4', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.321928094887363, first_block=None, height=2, validation='full'), aux_pow=None), group_id=0), latest_event_id=20),  # noqa E501
            ]),
            [
                # REORG_FINISHED
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=19, timestamp=1578878956.0, type=EventType.REORG_FINISHED, data=EmptyData(), group_id=0), latest_event_id=20),  # noqa E501
                # One NEW_VERTEX_ACCEPTED for a new block from manager2
                EventResponse(type='EVENT', event=BaseEvent(peer_id=self.peer_id, id=20, timestamp=1578878956.0, type=EventType.NEW_VERTEX_ACCEPTED, data=TxData(hash='a729a7abb4248dffa492dd2c2634aa6d92b3e1e05bfa6614118b6ba97bfba5c4', nonce=4136633663, timestamp=1578878941, version=0, weight=2.0, inputs=[], outputs=[TxOutput(value=6400, script='dqkUgQrqLefPfPVpkXlfvvAp943epyOIrA==', token_data=0)], parents=['4f0b3d13966f95f461d4edc6389c8440955e13a75f87c6bc2a4b455d813fb2f7', '16ba3dbe424c443e571b00840ca54b9ff4cff467e10b6a15536e718e2008f952', '33e14cb555a96967841dcbe0f95e9eab5810481d01de8f4f73afb8cce365e869'], tokens=[], token_name=None, token_symbol=None, metadata=TxMetadata(hash='a729a7abb4248dffa492dd2c2634aa6d92b3e1e05bfa6614118b6ba97bfba5c4', spent_outputs=[], conflict_with=[], voided_by=[], received_by=[], children=[], twins=[], accumulated_weight=2.0, score=4.321928094887363, first_block=None, height=2, validation='full'), aux_pow=None), group_id=None), latest_event_id=20)  # noqa E501
            ]
        ]

        _assert_equal_events(responses, expected)


class UnorderedList(list):
    pass


def _assert_equal_events(actual_events: list[EventResponse], expected_events: list[list[EventResponse]]) -> None:
    for actual_events_chunk, expected_events_chunk in zip_chunkify(actual_events, expected_events):
        if isinstance(expected_events_chunk, UnorderedList):
            actual_events_chunk = _sorted_by_hash_without_id(actual_events_chunk)
            expected_events_chunk = _sorted_by_hash_without_id(expected_events_chunk)

        assert expected_events_chunk == actual_events_chunk, (
            f'different chunks:\n\nexpected: {expected_events_chunk}\n\nactual: {actual_events_chunk}\n'
        )


def _sorted_by_hash_without_id(responses: list[EventResponse]) -> list[EventResponse]:
    responses_without_id = [response.copy(exclude={'event': {'id'}}) for response in responses]

    def key(response: EventResponse) -> str:
        assert isinstance(response.event.data, TxData), (
            f'only tx events can be sorted. event.data type: {type(response.event.data)}'
        )
        return response.event.data.hash

    return sorted(responses_without_id, key=key)


class MemoryEventSimulationScenariosTest(BaseEventSimulationScenariosTest, MemoryEventSimulationTester):
    __test__ = True


class RocksDBEventSimulationScenariosTest(BaseEventSimulationScenariosTest, RocksDBEventSimulationTester):
    __test__ = True
